<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>YouTube Carousel - Max Quality Edition</title>
    <style>
        body, html { 
            margin: 0; padding: 0; height: 100%; overflow: hidden; 
            background: black; cursor: none; 
        }

        #player-video { width: 100vw; height: 100vh; pointer-events: none !important; }
        #player-audio { position: absolute; top: -9999px; left: -9999px; width: 1px; height: 1px; }
        #shield { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: transparent; cursor: none; }
        
        #title-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 140px;
            background: linear-gradient(to bottom, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 100%);
            z-index: 10000; opacity: 0; transition: opacity 0.8s ease-in-out; pointer-events: none;
        }

        #timer-display {
            position: absolute;
            bottom: 20px;
            right: 30px;
            color: rgba(255, 255, 255, 0.7);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            font-size: 24px;
            font-weight: 300;
            z-index: 10001;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            letter-spacing: 1px;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="shield"></div>
    <div id="title-mask"></div>
    
    <div id="player-video"></div>
    <div id="player-audio"></div>

    <div id="timer-display">00:00</div>

    <script>
        const myPlaylistId = 'PLhNnjrSmvk-NC1dFuMu1T4qonEkt9L1vP'; 
        const audioVideoId = 'PO7FETKjmA4'; 
        const changeEverySeconds = 150; 
        
        let videoPlayer, audioPlayer;
        let secondsRemaining = changeEverySeconds;
        let availableIndices = [];

        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);

        function onYouTubeIframeAPIReady() {
            videoPlayer = new YT.Player('player-video', {
                height: '1080',
                width: '1920',
                playerVars: {
                    listType: 'playlist', 
                    list: myPlaylistId,
                    autoplay: 1, 
                    mute: 1, 
                    controls: 0, 
                    modestbranding: 1, 
                    rel: 0, 
                    disablekb: 1,
                    vq: 'hd1080' // Forza la richiesta HD ai server
                },
                events: {
                    'onReady': onVideoReady,
                    'onStateChange': onVideoStateChange,
                    'onError': playNextSmart
                }
            });

            audioPlayer = new YT.Player('player-audio', {
                height: '1', width: '1',
                videoId: audioVideoId,
                playerVars: { autoplay: 1, controls: 0, loop: 1, playlist: audioVideoId },
                events: {
                    'onReady': (e) => { e.target.setVolume(50); e.target.playVideo(); }
                }
            });
        }

        function onVideoReady(event) {
            // Tentativo ulteriore di forzare la qualitÃ 
            if (event.target.setPlaybackQuality) {
                event.target.setPlaybackQuality('hd1080');
            }
            refreshIndices();
            playNextSmart(); 
            startTimer();
        }

        function onVideoStateChange(event) {
            // Ogni volta che cambia il video, ri-tentiamo di forzare l'HD
            if (event.data === YT.PlayerState.PLAYING) {
                if (event.target.setPlaybackQuality) {
                    event.target.setPlaybackQuality('hd1080');
                }
            }
            if (event.data === YT.PlayerState.ENDED) playNextSmart();
        }

        function startTimer() {
            setInterval(() => {
                secondsRemaining--;
                const mins = Math.floor(secondsRemaining / 60);
                const secs = secondsRemaining % 60;
                document.getElementById('timer-display').innerText = 
                    (mins < 10 ? "0" : "") + mins + ":" + (secs < 10 ? "0" : "") + secs;
                
                if (secondsRemaining <= 0) playNextSmart();
            }, 1000);
        }

        function refreshIndices() {
            const playlist = videoPlayer.getPlaylist();
            availableIndices = [];
            if (playlist) {
                for (let i = 0; i < playlist.length; i++) availableIndices.push(i);
            }
        }

        function playNextSmart() {
            const playlist = videoPlayer.getPlaylist();
            if (!playlist) return;
            if (availableIndices.length === 0) refreshIndices();

            const randomIndexInArray = Math.floor(Math.random() * availableIndices.length);
            const videoIndexToPlay = availableIndices[randomIndexInArray];
            availableIndices.splice(randomIndexInArray, 1);

            videoPlayer.playVideoAt(videoIndexToPlay);
            secondsRemaining = changeEverySeconds;
            showMaskTemporarily();
        }

        function showMaskTemporarily() {
            const mask = document.getElementById('title-mask');
            mask.style.opacity = "1";
            setTimeout(() => { mask.style.opacity = "0"; }, 7000);
        }

        setTimeout(() => { location.reload(); }, 2 * 60 * 60 * 1000);
        document.addEventListener('mouseenter', () => { document.body.style.cursor = 'none'; });
    </script>
</body>
</html>
